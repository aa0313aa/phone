<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>예약현황 - 전국모바일</title>
  <link href="/assets/css/styles.css" rel="stylesheet">
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"></noscript>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4">예약 현황 (게시판 연동)</h1>
      <a class="btn btn-sm btn-outline-primary" href="/contact.html">문의 / 상담예약 돌아가기</a>
    </div>

    <div class="alert alert-info">이 페이지는 예약 게시판에 저장된 항목을 목록으로 보여줍니다. 실제 저장(POST) 엔드포인트가 설정되어 있으면 새 예약 등록이 게시판에 저장됩니다.</div>

    <div class="row">
      <div class="col-lg-6">
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">새 예약 등록</h5>
            <form id="reservationForm">
              <div class="mb-2">
                <label class="form-label">지역</label>
                <input name="region" class="form-control" placeholder="예: 광주" required>
              </div>
              <div class="mb-2">
                <label class="form-label">이름 (노출 원치 않으면 빈칸)</label>
                <input name="name" class="form-control" placeholder="홍*길">
              </div>
              <div class="mb-2">
                <label class="form-label">연락처 (마스킹 권장)</label>
                <input name="phone" class="form-control" placeholder="010-****-1234">
              </div>
              <div class="mb-2">
                <label class="form-label">방식</label>
                <select name="method" class="form-select">
                  <option>비대면 개통</option>
                  <option>방문 상담</option>
                </select>
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-primary" type="submit">저장(게시)</button>
                <button id="clearLocal" class="btn btn-outline-secondary" type="button">로컬 데이터 초기화</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">예약 리스트</h5>
            <div class="mb-2">
              <input id="filter" class="form-control" placeholder="지역/이름 검색">
            </div>
            <div style="overflow:auto; max-height:520px;" id="reservationsTableContainer">
              <table class="table table-sm">
                <thead>
                  <tr><th>지역</th><th>일시</th><th>이름</th><th>연락처</th><th>상태</th></tr>
                </thead>
                <tbody id="reservationsBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <hr>
    <p class="text-muted small">게시판 저장 엔드포인트가 없으면 로컬(브라우저) 저장 데모로 동작합니다. Apps Script/서버 엔드포인트를 연동하려면 관리자에게 배포 URL을 입력하세요.</p>
  </div>

  <script>
  (function(){
    // 설정: 서버 엔드포인트(POST/GET) - 로컬 Express 서버와 연동
    const ENDPOINT = '/api/reservations';
    const WRITE_TOKEN = ''; // POST 보호 토큰 (선택)

    function parseDemo(){
      try{
        const raw = localStorage.getItem('recentReservations') || '[]';
        return JSON.parse(raw);
      }catch(e){return []}
    }

    async function fetchBaseReservations(){
      // 우선 로컬 demo와 assets 파일을 병합
      let base = [];
      if (ENDPOINT){
        try{
          const res = await fetch(ENDPOINT);
          if (res.ok){
            const data = await res.json();
            base = Array.isArray(data) ? data : [];
          }
        }catch(e){ base = []; }
      } else {
        try{
          const res = await fetch('/assets/data/reservations.json');
          if (res.ok){ base = await res.json(); }
        }catch(e){ base = []; }
      }
      return Array.isArray(base) ? base : [];
    }

    function getMergedReservations(base){
      const local = parseDemo();
      // 로컬(브라우저에서 등록된 항목)을 base 앞에 붙임
      return local.concat(base);
    }

    async function renderReservations(){
      const body = document.getElementById('reservationsBody');
      const base = await fetchBaseReservations();
      const items = getMergedReservations(base);
      const q = (document.getElementById('filter').value || '').toLowerCase();
      const filtered = items.filter(it => !q || (it.region||'').toLowerCase().includes(q) || (it.name||'').toLowerCase().includes(q));
      body.innerHTML = filtered.slice(0,200).map(it => `
        <tr>
          <td>${escapeHtml(it.region||'')}</td>
          <td>${escapeHtml(it.datetime||'')}</td>
          <td>${escapeHtml(it.name||'')}</td>
          <td>${escapeHtml(it.phone||'')}</td>
          <td>${escapeHtml(it.status||'')}</td>
        </tr>
      `).join('');
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

    async function submitReservation(obj){
      // 로컬에 항상 저장(데모) — 서버 연동 가능 시 POST도 수행
      const demo = parseDemo();
      demo.unshift(obj);
      localStorage.setItem('recentReservations', JSON.stringify(demo.slice(0,200)));

      if (ENDPOINT){
        try{
          const payload = Object.assign({}, obj);
          if (WRITE_TOKEN) payload._token = WRITE_TOKEN;
          await fetch(ENDPOINT, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        }catch(e){console.warn('POST failed', e)}
      }
      await renderReservations();
    }

    document.getElementById('reservationForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const f = e.target;
      const data = {
        region: f.region.value.trim(),
        name: f.name.value.trim(),
        phone: f.phone.value.trim(),
        method: f.method.value,
        datetime: new Date().toISOString().replace('T',' ').slice(0,16),
        status: '접수완료'
      };
      await submitReservation(data);
      f.reset();
    });

    document.getElementById('clearLocal').addEventListener('click', function(){
      localStorage.removeItem('recentReservations');
      renderReservations();
    });

    document.getElementById('filter').addEventListener('input', function(){ renderReservations(); });

    // 초기 렌더링 및 30초 주기 갱신
    renderReservations();
    setInterval(renderReservations, 30000);
  })();
  </script>
</body>
</html>
